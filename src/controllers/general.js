const Finance = require('./finance');
const Habits = require('./habits');
const Weight = require('./weight');
const Settings = require('./settings');
const reportService = require('../services/report');
const keyboards = require('../keyboards');
const { Markup } = require('telegraf');
const { clearChat } = require('../utils/helpers');

module.exports = {
  async start(ctx) {
    await clearChat(ctx);
    ctx.reply(`–ü—Ä–∏–≤–µ—Ç, ${ctx.userConfig.name}!`, keyboards.MainMenu);
  },

  async help(ctx) {
    await clearChat(ctx);
    const msg = `
ü§ñ *–ì–∞–π–¥ –ø–æ –ñ–æ—Ä–∏–∫—É:*

*üìù –¢—É –î—É *
–°—é–¥–∞ —Å–∫–∏–¥—ã–≤–∞–π –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏–ª–∏ –Ω–µ –∑–∞–±—ã—Ç—å.
‚Ä¢ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞ -> _"–ü–æ–º–µ–Ω—è—Ç—å –ª–∞–º–ø–æ—á–∫—É"_.
‚Ä¢ –ü–æ—Ç–æ–º –∂–º–∏ "–†–∞–∑–≥—Ä–µ—Å—Ç–∏", —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.
‚Ä¢ –ï—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–ø–∏—Å–∫—É –ø–æ–∫—É–ø–æ–∫.

*üí° –ú—ã—Å–ª–∏*
–ú–∏–Ω–∏–¥–Ω–µ–≤–Ω–∏–∫ –∏ –¥–∞–º–ø –º–æ–∑–≥–∞. –ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã, –∏–¥–µ–∏, –æ—Ç–∑—ã–≤—ã –æ –º–µ—Å—Ç–∞—Ö.

*üóì –°–µ–≥–æ–¥–Ω—è / –ó–∞–≤—Ç—Ä–∞*
–°–ø–∏—Å–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –¥–µ–ª.

*üìÖ –í –ø–ª–∞–Ω—ã*
–°–æ–∑–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ Google –ö–∞–ª–µ–Ω–¥–∞—Ä–µ. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤—Ä–µ–º—è –∏ –¥–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
‚Ä¢ _"–ü–æ—Ö–æ–¥ –∫ –≤—Ä–∞—á—É –∑–∞–≤—Ç—Ä–∞ –≤ 13:00 "_, _"–í —á–µ—Ç–≤–µ—Ä–≥ –≤ 16:00 —Å–æ–∑–≤–æ–Ω"_, _"–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫"_.
‚Ä¢ –ú–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –º–µ–Ω—é, –∞ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–¥–∞—á—É –∏–∑ –æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞.

*üí∏ –†–∞—Å—Ö–æ–¥—ã*
–£—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤.
‚Ä¢ –ñ–º–∏ –∫–Ω–æ–ø–∫—É, –ø–∏—à–∏ —Å—É–º–º—É, –≤—ã–±–∏—Ä–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
‚Ä¢ –í –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞ –ø–æ—Å–º–æ—Ç—Ä–∏–º —Å—Ç—Ä–∞—à–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏.

*üõí –ü–æ–∫—É–ø–∫–∏*
–°–ø–∏—Å–æ–∫ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞. –ú–æ–∂–Ω–æ —Å–ø–∏—Å–∫–æ–º —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.
‚Ä¢ _"–ú–æ–ª–æ–∫–æ, —Ö–ª–µ–±, —è–π—Ü–∞"_ -> –¥–æ–±–∞–≤–∏—Ç 3 —Ç–æ–≤–∞—Ä–∞.
‚Ä¢ –í –º–∞–≥–∞–∑–∏–Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å —Å–ø–∏—Å–æ–∫ –∏ –≤—ã—á–µ—Ä–∫–∏–≤–∞–µ—à—å.

*‚öñÔ∏è –í–µ—Å*
–¢—Ä–µ–∫–µ—Ä —Ü–∏—Ñ–µ—Ä –Ω–∞ –≤–µ—Å–∞—Ö.
‚Ä¢ –°—Ç–∞–Ω–æ–≤–∏—Å—å –Ω–∞ –≤–µ—Å—ã, –∑–∞–ø–∏—Å—ã–≤–∞–π —Ü–∏—Ñ—Ä—ã.
‚Ä¢ –ú–æ–∂–µ—Ç, –≤ –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞ –ø–æ—Å–º–æ—Ç—Ä–∏–º –∫—Ä–∞—Å–∏–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏.

*‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏*
–¢—Ä–µ–∫–µ—Ä –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —Ä–∏—Ç—É–∞–ª–æ–≤ –∏ —Ä—É—Ç–∏–Ω.

*‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥*
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

*üìä –û—Ç—á–µ—Ç—ã*
–ú–æ–∂–Ω–æ –Ω–µ –∂–¥–∞—Ç—å –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ:
‚Ä¢ –§–∏–Ω–∞–Ω—Å–∞–º –∑–∞ –º–µ—Å—è—Ü.
‚Ä¢ –°–≤–æ–µ–º—É –≤–µ—Å—É –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è.
‚Ä¢ –°–≤–æ–∏–º –ø—Ä–∏–≤—ã—á–∫–∞–º –∑–∞ –ø—Ä–æ—à–µ–¥—à—É—é –Ω–µ–¥–µ–ª—é.

*‚ùì –ü–æ–º–æ—â—å*
[–¢–´ –ó–î–ï–°–¨]

_–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:_
/start - –ï—Å–ª–∏ –ø—Ä–æ–ø–∞–ª–æ –º–µ–Ω—é
`;
    ctx.replyWithMarkdown(msg, keyboards.MainMenu);
  },

  // --- –†–ê–°–ü–ò–°–ê–ù–ò–ï (–ö–Ω–æ–ø–∫–∏ "–°–µ–≥–æ–¥–Ω—è" / "–ó–∞–≤—Ç—Ä–∞") ---
  async schedule(ctx) {
    await clearChat(ctx);
    const text = ctx.message.text;
    const isTomorrow = text.toLowerCase().includes('–∑–∞–≤—Ç—Ä–∞');
    const targetDate = new Date();
    if (isTomorrow) targetDate.setDate(targetDate.getDate() + 1);

    ctx.reply('üîé –ó–∞–≥—Ä—É–∂–∞—é –ø–ª–∞–Ω...');

    const msg = await reportService.getDailyReport(
      targetDate,
      ctx.from.id,
      ctx.chat.type === 'private'
    );

    ctx.replyWithMarkdown(msg, keyboards.MainMenu);
  },

  // --- –ú–ï–ù–Æ –û–¢–ß–ï–¢–û–í ---
  async reportMenu(ctx) {
    await clearChat(ctx);

    const isPrivate = ctx.chat.type === 'private';
    const buttons = [];

    // –§–∏–Ω–∞–Ω—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤–µ–∑–¥–µ (–æ–±—â–∏–π –±—é–¥–∂–µ—Ç)
    buttons.push([Markup.button.callback('üí∞ –§–∏–Ω–∞–Ω—Å—ã (–ú–µ—Å—è—Ü)', 'rep_finance')]);

    // –õ–∏—á–Ω–æ–µ - —Ç–æ–ª—å–∫–æ –≤ –õ–°
    if (isPrivate) {
      buttons.push([Markup.button.callback('‚öñÔ∏è –í–µ—Å (–í—Å–µ –≤—Ä–µ–º—è)', 'rep_weight')]);
      buttons.push([Markup.button.callback('‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏ (7 –¥–Ω–µ–π)', 'rep_habits')]);
    }

    buttons.push([Markup.button.callback('üîô –û—Ç–º–µ–Ω–∞', 'cancel_scene')]);

    ctx.reply('üìä –ö–∞–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫–∞–∑–∞—Ç—å?', Markup.inlineKeyboard(buttons));
  },

  // –ü—Ä–æ–∫—Å–∏-–º–µ—Ç–æ–¥—ã —Å –∑–∞—â–∏—Ç–æ–π
  async callFinanceReport(ctx) {
    // –§–∏–Ω–∞–Ω—Å—ã –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è —Å–µ–º—å–∏
    await Finance.report(ctx);
  },

  async callWeightReport(ctx) {
    if (ctx.chat.type !== 'private') return ctx.answerCbQuery('üîí –≠—Ç–æ –ª–∏—á–Ω–æ–µ!');
    await Weight.report(ctx);
  },

  async callHabitsReport(ctx) {
    if (ctx.chat.type !== 'private') return ctx.answerCbQuery('üîí –≠—Ç–æ –ª–∏—á–Ω–æ–µ!');
    await Habits.report(ctx);
  }
};